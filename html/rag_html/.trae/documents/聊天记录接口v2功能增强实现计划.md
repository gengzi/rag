# 聊天记录接口v2功能增强实现计划

## 1. 问题分析

当前系统已经实现了基本的聊天功能，包括聊天历史加载、消息发送和流式响应处理。但是需要增强以下功能：

- 修改接口响应结构，新增`runMessageId`字段
- 实现自动续读机制，当检测到`runMessageId`时自动进入续读阶段
- 在续读阶段调用对话接口时新增`messageId`和`seqNum`参数
- 确保流式输出正确渲染
- 处理异常情况
- 添加日志记录

## 2. 实现方案

### 2.1 修改seqNum参数值

**文件：`src/hooks/useChatSubmission.ts`**
- 修改`sendMessage`函数中的`seqNum`参数，从0改为1
- 当前代码位置：第260行

### 2.2 增强错误处理机制

**文件：`src/hooks/useChatHistory.ts`**
- 在`loadMoreHistory`和`initialLoad`函数中添加更详细的错误处理
- 处理网络中断、接口超时等异常情况
- 添加适当的日志记录

**文件：`src/hooks/useChatSubmission.ts`**
- 在`sendMessage`和`handleStreamResponse`函数中增强错误处理
- 处理流式响应中断的情况
- 添加适当的日志记录

### 2.3 优化runMessageId处理逻辑

**文件：`src/app/dashboard/chat/v2/[id]/page.tsx`**
- 优化`runMessageId`的监听逻辑，确保能够正确处理多次变化
- 确保续读阶段的调用逻辑正确

### 2.4 添加日志记录

在以下关键位置添加日志记录：
- API调用前后
- 流式响应处理的关键节点
- 错误处理位置
- runMessageId检测和处理逻辑

### 2.5 确保流式输出正确渲染

**文件：`src/utils/messageFormatter.ts`**
- 确保`processStreamData`函数能够正确处理续读阶段的流式数据
- 确保消息渲染逻辑能够正确处理各种类型的消息

## 3. 实现步骤

1. 修改`useChatSubmission.ts`中的`seqNum`参数值
2. 增强`useChatHistory.ts`中的错误处理
3. 增强`useChatSubmission.ts`中的错误处理
4. 优化`page.tsx`中的`runMessageId`处理逻辑
5. 在关键位置添加日志记录
6. 测试整个流程，确保能够正确处理各种情况

## 4. 预期效果

- 当接口返回中包含`runMessageId`字段且不为空时，系统自动进入续读阶段
- 续读阶段调用对话接口时，正确传递`messageId`和`seqNum`参数
- 对话接口返回的流式输出能够按照现有渲染逻辑正确渲染
- 系统能够处理网络中断、接口超时等异常情况
- 关键位置有适当的日志记录，便于后续问题排查和性能优化

## 5. 风险评估

- 网络中断或接口超时可能导致续读失败
- 流式响应处理可能出现异常
- `runMessageId`处理逻辑可能出现竞态条件

## 6. 应对措施

- 增强错误处理机制，确保系统在异常情况下能够优雅降级
- 添加重试机制，在网络中断或接口超时后自动重试
- 优化`runMessageId`处理逻辑，避免竞态条件
- 添加详细的日志记录，便于问题排查

## 7. 测试计划

1. 测试正常流程，确保`runMessageId`能够正确触发续读
2. 测试异常情况，包括网络中断、接口超时等
3. 测试多次`runMessageId`变化的情况
4. 测试流式输出的渲染效果
5. 检查日志记录是否完整和有用