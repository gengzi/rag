# Dockerfile
FROM python:3.10-slim

# è®¾ç½®æ—¶åŒº & å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆtorchaudio éœ€è¦ï¼‰
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    libsndfile1 \
    ffmpeg \
    git \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£… Python ä¾èµ–ï¼ˆä½¿ç”¨å›½å†…æºåŠ é€Ÿï¼‰
RUN pip install --no-cache-dir -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt

# ğŸ‘‡ å…³é”®ï¼šå¤åˆ¶ä½ æœ¬åœ°çš„ OpenVoice æ–‡ä»¶å¤¹
COPY OpenVoice/ ./OpenVoice/

# ä»æœ¬åœ°ç›®å½•å®‰è£…ï¼ˆ-e è¡¨ç¤ºå¯ç¼–è¾‘æ¨¡å¼ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼‰
RUN pip install -e ./OpenVoice

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY streaming_tts.py .

# æš´éœ²ç«¯å£
EXPOSE 8000

# åœ¨ CMD å‰æ·»åŠ ï¼š
RUN python -c "
import os;
os.environ['HF_HOME'] = '/app/.cache';
from melo.api import TTS;
print('Pre-downloading OpenVoice models...');
tts = TTS(language='mix', device='cpu');
print('âœ… Models cached.')
"
ENV HF_HOME=/app/.cache

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "streaming_tts:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "1"]